# Orbis File Storage

Backend веб-приложение для управления файловым хранилищем, разработанное на FastAPI с использованием PostgreSQL базы данных.

## Описание

Приложение предоставляет REST API для загрузки, хранения, управления и скачивания файлов. Все метаданные файлов хранятся в базе данных PostgreSQL, а сами файлы в файловой системе сервера.

## Требования

- Python 3.12+
- PostgreSQL 15+
- Docker (рекомендуется для запуска)

## Запуск с Docker

1. Убедитесь, что Docker установлен.

2. Настройте переменные окружения:
   ```bash
   cp example.env .env
   # Отредактируйте .env файл
   ```

3. Запустите с Docker Compose:
   ```bash
   docker-compose up --build
   ```

Приложение будет доступно на `http://localhost:8000`

## Структура базы данных

Каждая запись в базе данных соответствует одному файлу и содержит следующие поля:

| Поле | Тип | Описание | Изменяемое |
|------|-----|----------|------------|
| uuid | string | Уникальный идентификатор файла | Нет |
| filename | string | Имя файла (без расширения) | Да |
| file_extension | string | Расширение файла (например, "txt") | Нет |
| size | integer | Размер файла в байтах | Нет |
| path | string | Полный путь расположения файла | Да |
| comment | string | Комментарий к файлу | Да |
| created_at | datetime | Дата создания (ISO формат) | Нет |
| updated_at | datetime | Дата последнего изменения (ISO формат) | Да |

## API Документация

Приложение использует JSON для всех ответов. Документация API доступна по адресу `http://localhost:8000/docs` (Swagger UI).

### Основные эндпоинты

#### Проверка здоровья
- **GET** `/health`
- Возвращает статус сервиса

#### Управление файлами

##### Загрузка файла
- **POST** `/files`
- Загружает новый файл и создает запись в БД
- Параметры формы: `filename`, `file_extension`, `path`, `comment` (опционально), `file`

##### Получение списка файлов
- **GET** `/files`
- Возвращает список всех файлов

##### Получение файла по ID
- **GET** `/files/{file_id}`
- Скачивает файл по его UUID

##### Получение метаданных файла по ID
- **GET** `/files/{file_id}/meta`
- Возвращает метаданные файла

##### Получение метаданных по полному пути
- **GET** `/files/meta/by-path?full_path={path}`
- Возвращает метаданные файла по полному пути

##### Поиск файлов по пути
- **GET** `/files/search?file_path={path}`
- Ищет файлы, содержащие указанный путь

##### Обновление метаданных файла
- **PUT** `/files/{file_id}` - Полная замена
- **PATCH** `/files/{file_id}` - Частичное обновление
- Обновляет имя, путь или комментарий файла

##### Удаление файла
- **DELETE** `/files/{file_id}`
- Удаляет файл из хранилища и БД

##### Синхронизация хранилища
- **POST** `/files/synchronise`
- Синхронизирует состояние БД с файловым хранилищем

## Примеры использования

### Загрузка файла
```bash
curl -X POST "http://localhost:8000/files" \
  -F "filename=myfile" \
  -F "file_extension=txt" \
  -F "path=/documents/" \
  -F "comment=My first file" \
  -F "file=@/path/to/local/file.txt"
```

### Получение списка файлов
```bash
curl "http://localhost:8000/files"
```

### Скачивание файла
```bash
curl -O "http://localhost:8000/files/{file_id}"
```

### Обновление метаданных
```bash
curl -X PATCH "http://localhost:8000/files/{file_id}" \
  -H "Content-Type: application/json" \
  -d '{"filename": "newname", "comment": "Updated comment"}'
```

## Пример ответа API

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "filename": "my-file",
  "file_extension": "txt",
  "size": 10325,
  "path": "/root-folder/my-storage/",
  "created_at": "2020-05-12T13:48:10.034677",
  "updated_at": null,
  "comment": "Мой первый текстовый файл"
}
```

## Настройка

Все настройки производятся через переменные окружения. Скопируйте `example.env` в `.env` и настройте по необходимости.

Основные переменные:
- `DATABASE_URL` - URL подключения к PostgreSQL
- `FILE_STORAGE_PATH` - путь к директории хранения файлов
- `APP_PORT` - порт приложения
- `DEBUG` - режим отладки

## Архитектура

Приложение построено по принципу чистой архитектуры:
- `app/api.py` - REST API эндпоинты
- `app/core/` - бизнес-логика и инфраструктура
- `app/repositories/` - работа с БД
- `app/schemas/` - Pydantic модели
- `app/exceptions/` - обработка ошибок


